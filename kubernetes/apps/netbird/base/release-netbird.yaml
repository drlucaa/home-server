apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netbird
  namespace: netbird
spec:
  interval: 10m
  chart:
    spec:
      chart: netbird
      sourceRef:
        kind: HelmRepository
        name: jaconi
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3

  valuesFrom:
    - kind: ConfigMap
      name: netbird-config
      valuesKey: clientId
      targetPath: auth.device.clientID
    - kind: ConfigMap
      name: netbird-config
      valuesKey: audience
      targetPath: auth.device.audience
    - kind: ConfigMap
      name: netbird-config
      valuesKey: authority
      targetPath: auth.device.authority
    - kind: ConfigMap
      name: netbird-config
      valuesKey: deviceAuthEndpoint
      targetPath: auth.device.deviceAuthorizationEndpoint
    - kind: ConfigMap
      name: netbird-config
      valuesKey: tokenEndpoint
      targetPath: auth.device.tokenEndpoint

  values:
    auth:
      device:
        provider: hosted
        scope: "openid profile email offline_access"
        useIDToken: false

    management:
      ingress:
        enabled: true
        className: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        hosts:
          api:
            host: api.netbird.trai.ch
            tls:
              secretName: netbird-management-tls
          grpc:
            host: grpc.api.netbird.trai.ch
            tls:
              secretName: netbird-management-grpc-tls
    signal:
      ingress:
        enabled: true
        className: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        hosts:
          signal:
            host: signal.netbird.trai.ch
            tls:
              secretName: netbird-signal-tls
    relay:
      ingress:
        enabled: true
        className: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-production"
        hosts:
          - host: relay.netbird.trai.ch
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - relay.netbird.trai.ch
            secretName: netbird-relay-tls

  # Chart doesn't populate these into the configure initContainer, so we patch them in.
  postRenderers:
    - kustomize:
        patches:
          - target:
              group: apps
              version: v1
              kind: Deployment
              name: netbird-management
            patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: netbird-management
              spec:
                template:
                  spec:
                    initContainers:
                      - name: configure
                        env:
                          - name: NETBIRD_AUTH_OIDC_CONFIGURATION_ENDPOINT
                            valueFrom:
                              configMapKeyRef:
                                name: netbird-config
                                key: oidcConfigEndpoint
                          - name: NETBIRD_AUTH_USER_ID_CLAIM
                            value: "sub"
                          - name: NETBIRD_AUTH_AUDIENCE
                            valueFrom:
                              configMapKeyRef:
                                name: netbird-config
                                key: audience
