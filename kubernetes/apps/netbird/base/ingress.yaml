apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: netbird
  namespace: netbird
spec:
  entryPoints:
    - websecure
  routes:
    # ----- Management (HTTP) -----
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/api`)
      kind: Rule
      services:
        - name: netbird-management
          port: 80
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/oauth2`)
      kind: Rule
      services:
        - name: netbird-management
          port: 80
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/ws-proxy/management`)
      kind: Rule
      services:
        - name: netbird-management
          port: 80

    # ----- Management (gRPC) -----
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/management.ManagementService/`)
      kind: Rule
      services:
        - name: netbird-management
          port: 33073
          scheme: h2c

    # ----- Signal (WebSocket/HTTP) -----
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/ws-proxy/signal`)
      kind: Rule
      services:
        - name: netbird-signal
          port: 80

    # ----- Signal (gRPC) -----
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/signalexchange.SignalExchange/`)
      kind: Rule
      services:
        - name: netbird-signal
          port: 10000
          scheme: h2c

    # ----- Relay (WebSocket) -----
    - match: Host(`netbird.trai.ch`) && PathPrefix(`/relay`)
      kind: Rule
      services:
        - name: netbird-relay
          port: 33080

    # ----- Dashboard catch-all -----
    - match: Host(`netbird.trai.ch`)
      kind: Rule
      services:
        - name: netbird-dashboard
          port: 80

  tls:
    secretName: netbird-tls
