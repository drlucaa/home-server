---
- name: Install UFW
  apt:
    name: ufw
    state: present
  tags: [ufw, security]

- name: Set UFW defaults
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: incoming, policy: deny }
    - { direction: outgoing, policy: allow }
  tags: [ufw]

# 1. SSH Access
- name: Allow SSH from restricted IPs
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    from_ip: "{{ item }}"
    comment: "SSH admin only"
  loop: "{{ admin_allowed_cidrs }}"
  when: admin_allowed_cidrs | length > 0
  tags: [ufw, ssh]

- name: Allow SSH with rate limiting (Fallback)
  community.general.ufw:
    rule: limit
    port: "22"
    proto: tcp
    comment: "SSH rate limited"
  when: admin_allowed_cidrs | length == 0
  tags: [ufw, ssh]

# 2. K3s API (Only on Primary/Master)
- name: Allow K3s API (6443) from Internal Network
  community.general.ufw:
    rule: allow
    port: "6443"
    proto: tcp
    # from_ip: "{{ item }}"
    comment: "K3s API Internal"
  loop: "{{ cluster_allowed_cidrs }}"
  when:
    - "'k3s_primary' in group_names"
    - cluster_allowed_cidrs | length > 0
  tags: [ufw, k3s]

# 3. K3s Internal Traffic (VXLAN & Metrics)
- name: Allow Flannel VXLAN (8472/udp)
  community.general.ufw:
    rule: allow
    port: "8472"
    proto: udp
    from_ip: "{{ item }}"
    comment: "Flannel VXLAN"
  loop: "{{ cluster_allowed_cidrs }}"
  when: cluster_allowed_cidrs | length > 0
  tags: [ufw, k3s]

- name: Allow Kubelet Metrics (10250/tcp)
  community.general.ufw:
    rule: allow
    port: "10250"
    proto: tcp
    from_ip: "{{ item }}"
    comment: "Kubelet Metrics"
  loop: "{{ cluster_allowed_cidrs }}"
  when: cluster_allowed_cidrs | length > 0
  tags: [ufw, k3s]

- name: Allow Ingress (HTTP/HTTPS)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
    comment: "Ingress"
  loop:
    - "80"
    - "443"
  tags: [ufw, k3s]

# 4. Enable Firewall
- name: Enable UFW
  community.general.ufw:
    state: enabled
  tags: [ufw]
