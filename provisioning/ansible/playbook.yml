---
- name: Configure K3s Nodes
  hosts: k3s_nodes
  gather_facts: yes
  become: yes

  handlers:
    - name: restart fail2ban
      service:
        name: fail2ban
        state: restarted

    - name: reload ufw
      community.general.ufw:
        state: reloaded

  tasks:
    # --- System Updates ---
    - name: Update apt cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist
      tags: [system]

    # --- Install Security Packages ---
    - name: Install security packages
      apt:
        name:
          - ufw
          - fail2ban
        state: present
      tags: [security]

    # --- UFW Configuration ---
    - name: Set UFW defaults
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: incoming, policy: deny }
        - { direction: outgoing, policy: allow }
      tags: [ufw]

    - name: Allow SSH connections
      community.general.ufw:
        rule: limit
        port: "22"
        proto: tcp
        comment: "SSH rate limited"
      tags: [ufw]

    - name: Allow Kubernetes API
      community.general.ufw:
        rule: allow
        port: "6443"
        proto: tcp
        comment: "K3s API"
      tags: [ufw]

    - name: Allow HTTP/HTTPS Traffic
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "80"
        - "443"
      tags: [ufw]

    - name: Enable UFW
      community.general.ufw:
        state: enabled
      tags: [ufw]

    # --- Fail2Ban Configuration ---
    - name: Configure Fail2Ban jail.local
      copy:
        dest: /etc/fail2ban/jail.local
        content: |
          [DEFAULT]
          bantime  = 1h
          findtime = 10m
          maxretry = 5

          [sshd]
          enabled = true
          port    = ssh
          logpath = %(sshd_log)s
          backend = %(sshd_backend)s
      notify: restart fail2ban
      tags: [fail2ban]

    - name: Ensure Fail2Ban is running
      service:
        name: fail2ban
        state: started
        enabled: yes
      tags: [fail2ban]
